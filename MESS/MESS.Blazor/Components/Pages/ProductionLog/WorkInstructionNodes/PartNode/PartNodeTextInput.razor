@using MESS.Data.Models

<div class="form-floating flex-grow-1">
    @switch (PartNode.InputType)
    {
        case PartInputType.SerialNumber:
            <InputText
                id="serialInput"
                class="form-control tall-input text-lightweight"
                placeholder="@PartNode.PartDefinition.Number"
                @bind-Value="_serialNumber"
                @bind-Value:after="OnInputChanged" />

            <label for="serialInput" class="form-label subtle-label">
                @(PartNode.PartDefinition.Name)
            </label>
            break;
        case PartInputType.ProductionLogId:
            <InputNumber TValue="int?" 
                         id="logInput"
                         class="form-control tall-input text-lightweight"
                         placeholder="@PartNode.PartDefinition.Number"
                         @bind-Value="_productionLogId"
                         @bind-Value:after="OnInputChanged" />

            <label for="logInput" class="form-label subtle-label">
                @(PartNode.PartDefinition.Name)
            </label>
            break;
        default:
            throw new ArgumentOutOfRangeException();
    }
</div>

@code {
    /// <summary>
    /// Determines which type of input should be rendered: serial number or production log ID.
    /// </summary>
    [Parameter, EditorRequired]
    public required PartNode PartNode { get; set; }

    /// <summary>
    /// The serializable part being edited. Only used for serial number input.
    /// </summary>
    [Parameter]
    public SerializablePart? SerializablePart { get; set; }

    [Parameter]
    public EventCallback<(PartNode node, object? value)> AfterInputChanged { get; set; }

    private string? _serialNumber;
    private int? _productionLogId;

    /// <summary>
    /// Synchronizes the component's internal input fields with the latest parameter values.
    /// <para>
    /// If the <see cref="PartNode"/> requires a serial number, this method initializes the
    /// backing field (<c>_serialNumber</c>) from the provided <see cref="SerializablePart"/>.
    /// For <see cref="PartInputType.ProductionLogId"/>, no initial value is populated and the
    /// input starts empty.
    /// </para>
    /// <remarks>
    /// This method runs each time incoming parameters change, ensuring the displayed input
    /// reflects the correct state when the component is updated or re-rendered by its parent.
    /// </remarks>
    /// </summary>
    protected override void OnParametersSet()
    {
        if (PartNode.InputType == PartInputType.SerialNumber)
        { 
            _serialNumber = SerializablePart?.SerialNumber;
        }
    }

    private async Task OnInputChanged()
    {
        object? updatedValue = PartNode.InputType switch
        {
            PartInputType.SerialNumber => UpdateSerialNumber(),
            PartInputType.ProductionLogId => _productionLogId,
            _ => throw new InvalidOperationException("Unknown PartNode input type.")
        };

        if (AfterInputChanged.HasDelegate)
            await AfterInputChanged.InvokeAsync((PartNode, updatedValue));
    }

    private string? UpdateSerialNumber()
    {
        if (SerializablePart is null)
            return null;

        SerializablePart.SerialNumber =
            string.IsNullOrWhiteSpace(_serialNumber) ? null : _serialNumber;

        return SerializablePart.SerialNumber;
    }
}