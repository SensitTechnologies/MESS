@using MESS.Data.Models
@using MESS.Services.Serialization
@using MESS.Blazor.Components.Pages.ProductionLog.WorkInstructionNodes
@using PartNode = MESS.Data.Models.PartNode
@using MESS.Blazor.Components.Pages.ProductionLog.WorkInstructionNodes.PartNode
@inject ISerializationService SerializationService

@if (ActiveWorkInstruction != null && ProductionLogs?.Any() == true)
{
    <ul class="step">
        @foreach (var workInstructionNode in ActiveWorkInstruction.Nodes.OrderBy(wn => wn.Position))
        {
            if (workInstructionNode is Step workInstructionStep && workInstructionNode.NodeType == WorkInstructionNodeType.Step)
            {
                // Ensure every log contains the step
                foreach (var log in ProductionLogs)
                {
                    if (log.LogSteps.All(ls => ls.WorkInstructionStepId != workInstructionStep.Id))
                    {
                        log.LogSteps.Add(new ProductionLogStep
                        {
                            WorkInstructionStepId = workInstructionStep.Id,
                            WorkInstructionStep = workInstructionStep,
                            ProductionLogId = log.Id,
                        });
                    }
                }

                // Gather all steps across logs for this node
                var logSteps = ProductionLogs
                    .SelectMany(p => p.LogSteps)
                    .Where(ls => ls.WorkInstructionStepId == workInstructionStep.Id)
                    .ToList();

                <li class="mb-3">
                    <div id="step-@workInstructionStep.Position">
                        <StepNodeListItem OnStepCompleted="OnStepCompleted" LogSteps="logSteps" Step="workInstructionStep" />
                    </div>
                </li>
            }
            else if (workInstructionNode is PartNode workInstructionPart && workInstructionNode.NodeType == WorkInstructionNodeType.Part)
            {
                <li class="mb-3">
                    <PartNodeListItem PartNode="workInstructionPart" ProductionLogs="ProductionLogs" />
                </li>
            }
            
        }
        @if (ActiveWorkInstruction.CollectsProductSerialNumber)
        {
            <div class="card card-body">
                <div class="mb-2">
                    <div class="form-label">
                        @(ProductionLogs.Count == 1 ? "Product Serial Number" : "Product Serial Numbers")
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 justify-content-around align-content-center">
                    @for (var i = 0; i < ProductionLogs.Count; i++)
                    {
                        var log = ProductionLogs[i];

                        <div class="form-floating flex-grow-1" style="min-width: 220px;">
                            <InputText
                                id=@($"productSerialNumber-{i}")
                                class="form-control tall-input text-lightweight"
                                @bind-Value="log.ProductSerialNumber" />
                            @if (ProductionLogs.Count > 1)
                            {
                                <label for=@($"productSerialNumber-{i}") class="form-label subtle-label">
                                    #@(i + 1)
                                </label>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </ul>
}

@code {
    /// <summary>
    /// The active work instruction being processed.
    /// </summary>
    [Parameter] public required WorkInstruction ActiveWorkInstruction { get; set; }

    /// <summary>
    /// The production logs associated with the current work instruction.
    /// </summary>
    [Parameter] public required List<ProductionLog> ProductionLogs { get; set; }

    /// <summary>
    /// Event callback triggered when a step is completed.
    /// The tuple contains the production log step and an optional boolean indicating completion status.
    /// </summary>
    [Parameter] public EventCallback<(List<ProductionLogStep>, bool?)> OnStepCompleted { get; set; }

    private string? SelectedButton { get; set; } = "";

    private void SetSelectedButton(string buttonName)
    {
        if (SelectedButton == buttonName)
        {
            SelectedButton = null;
        }
        else
        {
            SelectedButton = buttonName;
        }
    }

    private void ClearSelectedButton()
    {
        SelectedButton = null;
    }

    private string GetButtonClass(string buttonName)
    {
        string baseClass = "btn";

        if (buttonName == "Clear")
        {
            return string.IsNullOrEmpty(SelectedButton) ? $"{baseClass} btn-secondary" : $"{baseClass} btn-warning";
        }

        return SelectedButton == buttonName ? $"{baseClass} btn-primary" : $"{baseClass} btn-success";
    }
}
