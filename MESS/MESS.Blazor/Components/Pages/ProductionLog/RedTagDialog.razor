@inject IProductionLogEventService ProductionLogEventService
@inject IJSRuntime JSRuntime
@implements IDisposable
@using MESS.Data.Models
@using MESS.Services.ProductionLog
@implements IAsyncDisposable

<div id="red-tag-printable" class="red-tag-horizontal-wrapper print-only" style="width: 456px; height: 228px;">
    <div class="red-tag-horizontal">
        <div class="red-tag-hole"></div>
        <div class="red-tag-content">
            <div class="tag-info-grid">
                <!-- Row 1 -->
                <div class="tag-item"><span class="label">RED TAG</span></div>
                <div class="tag-item"><span class="label">Date:</span> <span>@DateTime.Now.ToString("g")</span></div>
                <div class="tag-item"><span class="label">ID:</span> <span>@(AttemptCount > 0 ? AttemptCount.ToString() : "None")</span></div>
                <div class="tag-item"><span class="label">Product:</span> <span>@ProductionLogEventService.CurrentProductName</span></div>
                <div class="tag-item"><span class="label">Part Name:</span></div>
                <div class="tag-item"><span class="label">Part #:</span></div>

                <!-- Row 2 -->
                <div class="tag-item"><span class="label">Work Instruction:</span> <span>@ProductionLogEventService.CurrentWorkInstructionName</span></div>
                <div class="tag-item"><span class="label">Step:</span> <span>@(LogSteps?.FirstOrDefault()?.WorkInstructionStep?.Name ?? "(No Step)")</span></div>
                <div class="tag-item"><span class="label">Operator:</span> <span>@ProductionLogEventService.CurrentLineOperatorName</span></div>
            </div>

            <div class="failure-note"><span class="label">Failure Note:</span> <span>@FailureNotes</span></div>
        </div>
    </div>
</div>

<div class="mt-3 d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-outline-secondary" @onclick="OnCancelClicked">Cancel</button>
    <button type="button" class="btn btn-outline-secondary" @onclick="OnSubmitClicked">Print</button>
</div>

@code {
    /// <summary>
    /// The current attempt count for the failure event.
    /// </summary>
    [Parameter] public int AttemptCount { get; set; }

    /// <summary>
    /// The list of log steps associated with this red tag entry.
    /// </summary>
    [Parameter] public List<ProductionLogStep>? LogSteps { get; set; }

    /// <summary>
    /// Notes provided for the failure.
    /// </summary>
    [Parameter] public string FailureNotes { get; set; } = "";

    /// <summary>
    /// Event callback triggered when the Cancel button is clicked.
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Event callback triggered when the Print button is clicked and processing is completed.
    /// </summary>
    [Parameter] public EventCallback OnSubmit { get; set; }

    /// <summary>
    /// The JavaScript module reference used for printing the red tag.
    /// </summary>
    private IJSObjectReference? _jsModule;

    /// <summary>
    /// Loads the JavaScript module after the component has rendered for the first time.
    /// </summary>
    /// <param name="firstRender">Indicates if this is the first time the component is rendering.</param>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "/Scripts/RedTagDialog.js");
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Failed to load JS module: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Handles the Cancel button click by invoking the OnCancel callback.
    /// </summary>
    private async Task OnCancelClicked()
    {
        await OnCancel.InvokeAsync();
    }

    /// <summary>
    /// Handles the Print button click, prints the red tag, logs the failure attempt, and invokes OnSubmit.
    /// </summary>
    private async Task OnSubmitClicked()
    {
        if (_jsModule != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("printRedTagById", "red-tag-printable");
            }
            catch (JSException ex)
            {
                Console.Error.WriteLine($"JS call failed: {ex.Message}");
            }
        }

        if (LogSteps != null)
        {
            var failureAttempt = new ProductionLogStepAttempt
            {
                Success = false,
                SubmitTime = DateTimeOffset.UtcNow,
                Notes = FailureNotes
            };

            foreach (var step in LogSteps)
            {
                step.Attempts.Add(failureAttempt);
            }

            await ProductionLogEventService.ChangeMadeToProductionLog();
        }

        await OnSubmit.InvokeAsync();
    }

    /// <summary>
    /// Disposes the JS module asynchronously.
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        if (_jsModule is not null)
        {
            await _jsModule.DisposeAsync();
        }
    }

    /// <summary>
    /// Synchronous dispose method. Currently no synchronous resources to dispose.
    /// </summary>
    public void Dispose()
    {
        // No synchronous disposable resources
    }
}
