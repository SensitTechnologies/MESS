@using MESS.Data.Models
@inherits ComponentBase

@if (PartNode?.PartDefinition is not null)
{
    <div class="d-flex align-items-start justify-content-between">
        <div class="row">
            <div class="col-12">
                <div class="part-node border rounded ps-2 py-2 h-100">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-4">
                            <label class="form-label"><strong>Part Number</strong></label>
                            <input type="text"
                                   class="form-control"
                                   value="@PartNode.PartDefinition.Number"
                                   @oninput="e => OnPartChanged(e, nameof(PartDefinition.Number))" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label"><strong>Part Name</strong></label>
                            <input type="text"
                                   class="form-control"
                                   value="@PartNode.PartDefinition.Name"
                                   @oninput="e => OnPartChanged(e, nameof(PartDefinition.Name))" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <NodeActionMenu OnAction="HandleNodeAction" />
    </div>
}
else
{
    <div class="alert alert-warning">No part data available.</div>
}

@code {

    [Parameter]
    public EventCallback<(WorkInstructionNode node, string action)> OnNodeAction { get; set; }

    [Parameter]
    public EventCallback OnChanged { get; set; }

    [Parameter, EditorRequired]
    public PartNode? PartNode { get; set; }

    private async Task HandleNodeAction(string action)
    {
        if (PartNode is null)
            return;

        if (OnNodeAction.HasDelegate)
            await OnNodeAction.InvokeAsync((PartNode, action));

        await NotifyChangedAsync();
    }

    private async Task OnPartChanged(ChangeEventArgs e, string propertyName)
    {
        if (PartNode?.PartDefinition is null)
            return;

        var newValue = e.Value?.ToString() ?? string.Empty;

        if (propertyName == nameof(PartDefinition.Number))
            PartNode.PartDefinition.Number = newValue;
        else if (propertyName == nameof(PartDefinition.Name))
            PartNode.PartDefinition.Name = newValue;

        await NotifyChangedAsync();
    }

    private async Task NotifyChangedAsync()
    {
        if (OnChanged.HasDelegate)
            await OnChanged.InvokeAsync();
    }
}