@page "/auth/Login"
@using Azure.Core
@using MESS.Data.Models
@using MESS.Services.ApplicationUser
@using Microsoft.AspNetCore.Components.Authorization
@using Serilog
@inject NavigationManager Navigation
@inject IApplicationUserService ApplicationUserService
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView>
    <Authorized>
        <p>You are logged in as: @context.User.Identity?.Name</p>
        <form method="post" action="/api/auth/logout">
            <button type="submit">Logout</button>
        </form>
    </Authorized>
    <NotAuthorized>
        <div>
            <form method="post" action="/api/auth/login">
                <AntiforgeryToken />
                <div>
                    <label for="email">Email:</label>
                    <select id="email" name="email" class="form-select">
                        <option value="">-- Select an operator --</option>
                        @if (LineOperators != null)
                        {
                            @foreach (var lineOperator in LineOperators)
                            {
                                <option value="@lineOperator.Email">@lineOperator.Email</option>
                            }
                        }
                    </select>
                </div>
                <button type="submit">Login</button>
            </form>
            @if (!string.IsNullOrEmpty(Navigation.Uri) && Navigation.Uri.Contains("error=true"))
            {
                <div class="error">Login failed. Please check your credentials.</div>
            }
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<ApplicationUser>? LineOperators { get; set; }

    protected override async Task OnInitializedAsync()
    {
        LineOperators = await ApplicationUserService.GetUsersByRoleAsync("Operator");
    }
}